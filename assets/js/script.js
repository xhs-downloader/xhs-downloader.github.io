const translations = {
  zh: {
    "logo-text": "小红书下载器",
    "nav-home": "首页",
    "nav-how-to": "使用教程",
    "nav-faq": "常见问题",
    "nav-tools": "其他工具",

    "hero-title": "免费下载小红书视频和图片",
    "hero-description":
      "简单易用的小红书内容下载工具，支持无水印下载视频、图片和文案，无需安装任何软件",
    "url-input": "粘贴小红书分享链接...",
    "download-button": "下载",
    "feature-1": "完全免费",
    "feature-2": "无水印下载",
    "feature-3": "无需安装",
    "feature-4": "安全可靠",

    "how-to-title": "如何使用",
    "how-to-description": "只需简单三步，即可下载小红书内容",
    "step-1-title": "复制链接",
    "step-1-description":
      "在小红书App中打开你想要下载的视频或图片，点击分享按钮复制链接",
    "step-2-title": "粘贴链接",
    "step-2-description": '将复制的链接粘贴到上方输入框中，点击"立即下载"按钮',
    "step-3-title": "下载内容",
    "step-3-description":
      "等待解析完成后，选择你想要下载的视频或图片，保存到设备",

    "faq-title": "常见问题",
    "faq-description": "关于小红书下载器的常见问题解答",
    "faq-1-question": "这个工具是免费的吗？",
    "faq-1-answer":
      "是的，我们的工具完全免费使用，没有任何隐藏费用或订阅要求。",
    "faq-2-question": "下载的内容会有水印吗？",
    "faq-2-answer": "不会，我们提供的是无水印下载，下载的内容将保持原始质量。",
    "faq-3-question": "支持下载哪些类型的内容？",
    "faq-3-answer": "我们支持下载小红书上的视频、图片和文案内容。",
    "faq-4-question": "需要安装软件吗？",
    "faq-4-answer": "不需要，我们的工具完全基于网页，无需下载或安装任何软件。",
    "faq-5-question": "下载的内容可以商用吗？",
    "faq-5-answer":
      "请注意，下载的内容可能受版权保护，请遵守相关法律法规和平台规定，尊重原创作者的权益。",

    "tools-title": "其他实用工具",
    "tools-description": "发现更多有用的在线工具",
    "tool-1-title": "Chrome Extension&Theme",
    "tool-1-description":
      "Chrome Extension&Theme 提供丰富的Chrome扩展和主题，助你打造个性化的浏览器体验",
    "tool-2-title": "Markdown Editor",
    "tool-2-description": "Markdown Editor 是一个在线的Markdown编辑器，支持实时预览和导出",
    "tool-3-title": "Bing Wallpaper",
    "tool-3-description": "Bing Wallpaper 提供每日更新的Bing壁纸，让你每天都看到不同的美景",
    // "tool-4-title": "内容分析工具",
    // "tool-4-description": "分析小红书内容表现和趋势",

    "footer-about-title": "小红书下载器",
    "footer-about-description":
      "免费、安全、易用的小红书内容下载工具，支持无水印下载视频、图片和文案。",
    "footer-links-title": "快速链接",
    "footer-link-home": "首页",
    "footer-link-how-to": "使用教程",
    "footer-link-faq": "常见问题",
    "footer-link-privacy": "隐私政策",
    "footer-link-about": "关于",
    "copyright-text": "©2025 小红书下载器 - 保留所有权利",
  },
  en: {
    "logo-text": "Xiaohongshu Downloader",
    "nav-home": "Home",
    "nav-how-to": "How to Use",
    "nav-faq": "FAQ",

    "nav-tools": "Other Tools",

    "hero-title": "Download Xiaohongshu Videos & Images for Free",
    "hero-description":
      "Easy-to-use Xiaohongshu content download tool, supports watermark-free download of videos, images and text. No software installation required.",
    "url-input": "Paste Xiaohongshu share link...",
    "download-button": "Download",
    "feature-1": "Completely Free",
    "feature-2": "Watermark-Free",
    "feature-3": "No Installation",
    "feature-4": "Safe & Secure",

    "how-to-title": "How to Use",
    "how-to-description": "Download Xiaohongshu content in just 3 simple steps",
    "step-1-title": "Copy Link",
    "step-1-description":
      "Open the video or image you want to download in Xiaohongshu app, tap the share button and copy the link",
    "step-2-title": "Paste Link",
    "step-2-description":
      'Paste the copied link into the input box above and click the "Download Now" button',
    "step-3-title": "Download Content",
    "step-3-description":
      "After parsing is complete, select the video or image you want to download and save it to your device",

    "faq-title": "Frequently Asked Questions",
    "faq-description": "Common questions about Xiaohongshu Downloader",
    "faq-1-question": "Is this tool free to use?",
    "faq-1-answer":
      "Yes, our tool is completely free to use with no hidden fees or subscription requirements.",
    "faq-2-question": "Will downloaded content have watermarks?",
    "faq-2-answer":
      "No, we provide watermark-free downloads. Downloaded content will maintain original quality.",
    "faq-3-question": "What types of content are supported?",
    "faq-3-answer":
      "We support downloading videos, images and text content from Xiaohongshu.",
    "faq-4-question": "Do I need to install any software?",
    "faq-4-answer":
      "No, our tool is completely web-based and requires no downloads or software installation.",
    "faq-5-question": "Can downloaded content be used commercially?",
    "faq-5-answer":
      "Please note that downloaded content may be protected by copyright. Please comply with relevant laws and platform regulations, and respect the rights of original creators.",

    "tools-title": "Other Useful Tools",
    "tools-description": "Discover more helpful online tools",
    "tool-1-title": "Chrome Extension&Theme",
    "tool-1-description":
      "Chrome Extension&Theme, a collection of useful Chrome extensions and themes",
    "tool-2-title": "Markdown Editor",
    "tool-2-description": "A Markdown editor for writing and previewing Markdown content",
    "tool-3-title": "Bing Wallpaper",
    "tool-3-description": "Bing Wallpaper, a tool for downloading Bing daily wallpapers",
    // "tool-4-title": "Content Analysis Tool",
    // "tool-4-description": "Analyze Xiaohongshu content performance and trends",

    "footer-about-title": "Xiaohongshu Downloader",
    "footer-about-description":
      "Free, safe and easy-to-use Xiaohongshu content download tool, supports watermark-free download of videos, images and text.",
    "footer-links-title": "Quick Links",
    "footer-link-home": "Home",
    "footer-link-how-to": "How to Use",
    "footer-link-faq": "FAQ",
    "footer-legal-title": "Legal",
    "footer-link-privacy": "Privacy Policy",
    "footer-link-about": "About Us",
    "copyright-text": "©2025 Xiaohongshu Downloader - All Rights Reserved",
  },
};

function switchLanguage(lang) {
  Object.keys(translations[lang]).forEach((key) => {
    const element = document.getElementById(key);
    if (element) {
      if (element.tagName === "INPUT") {
        element.placeholder = translations[lang][key];
      } else {
        element.textContent = translations[lang][key];
      }
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  const defultLang = "en";
  switchLanguage(defultLang);
  document
    .querySelector(`.language-option[data-lang='${defultLang}']`)
    .classList.add("active");
  document.querySelectorAll(".language-option").forEach((option) => {
    option.addEventListener("click", function () {
      const lang = this.getAttribute("data-lang");

      document.querySelectorAll(".language-option").forEach((opt) => {
        opt.classList.remove("active");
      });
      this.classList.add("active");
      switchLanguage(lang);
    });
  });

  document.querySelectorAll(".faq-question").forEach((question) => {
    question.addEventListener("click", () => {
      const item = question.parentElement;
      item.classList.toggle("active");
      const icon = question.querySelector("span:last-child");
      icon.textContent = item.classList.contains("active") ? "-" : "+";
    });
  });

  document.querySelector(".mobile-menu").addEventListener("click", () => {
    document.querySelector(".nav-menu").classList.toggle("active");
  });

  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener("click", function (e) {
      e.preventDefault();
      const targetId = this.getAttribute("href");
      if (targetId === "#") return;

      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        window.scrollTo({
          top: targetElement.offsetTop - 80,
          behavior: "smooth",
        });

        if (window.innerWidth <= 768) {
          document.querySelector(".nav-menu").classList.remove("active");
        }
      }
    });
  });

  document.querySelector(".download")?.addEventListener("click", download);
});
async function download(e) {
  e.preventDefault();
  const url = document.querySelector("#url-input").value;
  if (url) {
    try {
      setLoading(true);
      const keyHex =
        "d2f1e4c8a4b9e7f0d4c8b3a2f4e4d8c9b6a5f4e2d6c1b1a9f8e7d5c5b4a3d2e1";
      const timestamp = Math.floor(Date.now() / 1000);
      const s = `s3$vF!${timestamp.toString(16)}www.v2ob.com#6dKq^`;
      const encoder = new TextEncoder();
      const key = await crypto.subtle.importKey(
        "raw",
        encoder.encode(keyHex),
        {
          name: "HMAC",
          hash: { name: "SHA-256" },
        },
        false,
        ["sign"]
      );
      const signature = await crypto.subtle.sign(
        "HMAC",
        key,
        encoder.encode(s)
      );
      // ArrayBuffer → Base64
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
      }
      const headers = new Headers();
      headers.append("Content-Type", "application/json");
      headers.append(
        "Authorization",
        `timestamp=${timestamp},token=${arrayBufferToBase64(signature)}`
      );
      const response = await fetch(
        `https://xhs-download-api.onrender.com/download?url=${url}`,
        {
          headers: headers,
          method: "GET",
        }
      );
      const res = await response.json();
      if (res.code === 200 && res.data) {
        await doDownload(res.data);
      } else {
        showToast("error", "Url anlalysis failed!");
      }
    } catch (error) {
      console.error(error);
      showToast("error", error.message);
    } finally {
      setLoading(false);
    }
  } else {
    showToast("warning", "Please input a video url!");
  }
}

async function doDownload(data) {
  // download the video with blob
  const title = data.title;
  const zip = new JSZip();
  if (!data.imsges) {
    const videoUrl = data.url;
    const coverUrl = data.cover;
    if (videoUrl) {
      await zipVideos(zip, title, videoUrl, coverUrl);
    }
  } else {
    const picsUrl = data.imsges;
    if (picsUrl?.length > 0) {
      await zipImages(zip, title, picsUrl);
    }
  }
  const zipBlob = await zip.generateAsync({ type: "blob" });
  saveBlob(zipBlob, `${title}.zip`);
}

async function zipImages(zip, title, images) {
  for (let i = 0; i < images.length; i++) {
    let url = images[i];
    try {
      const res = await fetch(url.replace("http://", "https://"));
      const blob = await res.blob();

      zip.file(`${title}_${i + 1}.jpg`, blob, { binary: true });
    } catch (e) {
      console.log("Error fetching image:", e);
      showToast("error", "Error fetching image:" + e.getMessage());
    }
  }
}
async function zipVideos(zip, title, videoUrl, coverUrl) {
  try {
    const videoRes = await fetch(videoUrl.replace("http://", "https://"));
    const videoblob = await videoRes.blob();

    const coverRes = await fetch(coverUrl.replace("http://", "https://"));
    const coverblob = await coverRes.blob();
    zip.file(`${title}.mp4`, videoblob, { binary: true });
    zip.file(`${title}.jpg`, coverblob, { binary: true });
  } catch (e) {
    console.log("Error fetching video:", e);
    showToast("error", "Error fetching video:" + e.getMessage());
  }
}

function saveBlob(blob, name = null) {
  if (window.navigator.msSaveBlob) {
    if (name) window.navigator.msSaveBlob(blob, name);
    else window.navigator.msSaveBlob(blob);
  } else {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    if (name) a.download = name;
    a.style.display = "none";
    a.click();
  }
}

function showToast(type, message, duration = 3000) {
  let container = document.querySelector("#toast-container");
  if (!container) {
    container = document.createElement("div");
    container.classList.add("toast-container");
    container.classList.add("top-center");
    container.setAttribute("role", "alert");
    container.setAttribute("aria-live", "polite");
    container.setAttribute("aria-atomic", "true");
    container.id = "toast-container";
    document.body.appendChild(container);
  }
  const toastId = `toast-${guid()}`;
  const toast = document.createElement("div");
  toast.id = toastId;
  toast.className = `toast toast-${type}`;
  toast.setAttribute("role", "status");
  let iconSvg = "";
  switch (type) {
    case "success":
      iconSvg =
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>';
      break;
    case "error":
      iconSvg =
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      break;
    case "warning":
      iconSvg =
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
      break;
    case "info":
      iconSvg =
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
      break;
  }

  toast.innerHTML = `
      <div class="toast-icon">${iconSvg}</div>
      <div class="toast-content">${message}</div>
      <button class="toast-close" aria-label="Close toast" onclick="removeToast('${toastId}')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    `;
  container.appendChild(toast);
  setTimeout(() => {
    removeToast(toastId);
  }, duration);
  return toastId;
}

function removeToast(id) {
  const toast = document.getElementById(id);
  if (!toast) return;
  toast.classList.add("toast-removing");
  toast.addEventListener("animationend", () => {
    toast.remove();
  });
}

function guid() {
  const s4 = () => {
    return Math.floor((1 + Math.random()) * 0x10000)
      .toString(16)
      .substring(1);
  };

  return (
    s4() +
    s4() +
    "-" +
    s4() +
    "-" +
    s4() +
    "-" +
    s4() +
    "-" +
    s4() +
    s4() +
    s4()
  );
}

function setLoading(isLoading) {
  const spinner = document.querySelector(".spinner");
  const downloadBtn = document.querySelector(".download");
  const buttonText = downloadBtn.querySelector("span");
  const buttonIcon = downloadBtn.querySelector("svg");
  if (isLoading) {
    spinner.style.display = "inline-block";
    buttonText.textContent = "Downloading...";
    buttonIcon.style.display = "none";
    downloadBtn.disabled = true;
  } else {
    spinner.style.display = "none";
    buttonText.textContent = "Download";
    buttonIcon.style.display = "inline";
    downloadBtn.disabled = false;
  }
}
